!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@xinix/xin")):"function"==typeof define&&define.amd?define(["@xinix/xin"],t):"object"==typeof exports?exports.router=t(require("@xinix/xin")):(e.xin=e.xin||{},e.xin.router=t(e.xin))}(window,function(e){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=8)}([function(t,r){t.exports=e},function(e,t,r){"use strict";t.decode=t.parse=r(2),t.encode=t.stringify=r(3)},function(e,t,r){"use strict";function n(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.exports=function(e,t,r,o){t=t||"&",r=r||"=";var s={};if("string"!=typeof e||0===e.length)return s;var a=/\+/g;e=e.split(t);var u=1e3;o&&"number"==typeof o.maxKeys&&(u=o.maxKeys);var c=e.length;u>0&&c>u&&(c=u);for(var h=0;h<c;++h){var l,p,f,d,m=e[h].replace(a,"%20"),_=m.indexOf(r);_>=0?(l=m.substr(0,_),p=m.substr(_+1)):(l=m,p=""),f=decodeURIComponent(l),d=decodeURIComponent(p),n(s,f)?i(s[f])?s[f].push(d):s[f]=[s[f],d]:s[f]=d}return s};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},function(e,t,r){"use strict";var n=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};e.exports=function(e,t,r,a){return t=t||"&",r=r||"=",null===e&&(e=void 0),"object"==typeof e?o(s(e),function(s){var a=encodeURIComponent(n(s))+r;return i(e[s])?o(e[s],function(e){return a+encodeURIComponent(n(e))}).join(t):a+encodeURIComponent(n(e[s]))}).join(t):a?encodeURIComponent(n(a))+r+encodeURIComponent(n(e)):""};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function o(e,t){if(e.map)return e.map(t);for(var r=[],n=0;n<e.length;n++)r.push(t(e[n],n));return r}var s=Object.keys||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t}},function(e,t,r){(function(n){t.log=function(...e){return"object"==typeof console&&console.log&&console.log(...e)},t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;t.splice(1,0,r,"color: inherit");let n=0,i=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(n++,"%c"===e&&(i=n))}),t.splice(i,0,r)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==n&&"env"in n&&(e=n.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.exports=r(6)(t);const{formatters:i}=e.exports;i.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}).call(this,r(5))},function(e,t){var r,n,i=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(r===setTimeout)return setTimeout(e,0);if((r===o||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:o}catch(e){r=o}try{n="function"==typeof clearTimeout?clearTimeout:s}catch(e){n=s}}();var u,c=[],h=!1,l=-1;function p(){h&&u&&(h=!1,u.length?c=u.concat(c):l=-1,c.length&&f())}function f(){if(!h){var e=a(p);h=!0;for(var t=c.length;t;){for(u=c,c=[];++l<t;)u&&u[l].run();l=-1,t=c.length}u=null,h=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===s||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function d(e,t){this.fun=e,this.array=t}function m(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];c.push(new d(e,t)),1!==c.length||h||a(f)},d.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=m,i.addListener=m,i.once=m,i.off=m,i.removeListener=m,i.removeAllListeners=m,i.emit=m,i.prependListener=m,i.prependOnceListener=m,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},function(e,t,r){e.exports=function(e){function t(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return n.colors[Math.abs(t)%n.colors.length]}function n(e){let r;function s(...e){if(!s.enabled)return;const t=s,i=Number(new Date),o=i-(r||i);t.diff=o,t.prev=r,t.curr=i,r=i,e[0]=n.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let a=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(r,i)=>{if("%%"===r)return r;a++;const o=n.formatters[i];if("function"==typeof o){const n=e[a];r=o.call(t,n),e.splice(a,1),a--}return r}),n.formatArgs.call(t,e),(t.log||n.log).apply(t,e)}return s.namespace=e,s.enabled=n.enabled(e),s.useColors=n.useColors(),s.color=t(e),s.destroy=i,s.extend=o,"function"==typeof n.init&&n.init(s),n.instances.push(s),s}function i(){const e=n.instances.indexOf(this);return-1!==e&&(n.instances.splice(e,1),!0)}function o(e,t){const r=n(this.namespace+(void 0===t?":":t)+e);return r.log=this.log,r}function s(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return n.debug=n,n.default=n,n.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},n.disable=function(){const e=[...n.names.map(s),...n.skips.map(s).map(e=>"-"+e)].join(",");return n.enable(""),e},n.enable=function(e){let t;n.save(e),n.names=[],n.skips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),i=r.length;for(t=0;t<i;t++)r[t]&&("-"===(e=r[t].replace(/\*/g,".*?"))[0]?n.skips.push(new RegExp("^"+e.substr(1)+"$")):n.names.push(new RegExp("^"+e+"$")));for(t=0;t<n.instances.length;t++){const e=n.instances[t];e.enabled=n.enabled(e.namespace)}},n.enabled=function(e){if("*"===e[e.length-1])return!0;let t,r;for(t=0,r=n.skips.length;t<r;t++)if(n.skips[t].test(e))return!1;for(t=0,r=n.names.length;t<r;t++)if(n.names[t].test(e))return!0;return!1},n.humanize=r(7),Object.keys(e).forEach(t=>{n[t]=e[t]}),n.instances=[],n.names=[],n.skips=[],n.formatters={},n.selectColor=t,n.enable(n.load()),n}},function(e,t){var r=1e3,n=60*r,i=60*n,o=24*i,s=7*o,a=365.25*o;function u(e,t,r,n){var i=t>=1.5*r;return Math.round(e/r)+" "+n+(i?"s":"")}e.exports=function(e,t){t=t||{};var c=typeof e;if("string"===c&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var u=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return u*a;case"weeks":case"week":case"w":return u*s;case"days":case"day":case"d":return u*o;case"hours":case"hour":case"hrs":case"hr":case"h":return u*i;case"minutes":case"minute":case"mins":case"min":case"m":return u*n;case"seconds":case"second":case"secs":case"sec":case"s":return u*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return u;default:return}}(e);if("number"===c&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=o)return u(e,t,o,"day");if(t>=i)return u(e,t,i,"hour");if(t>=n)return u(e,t,n,"minute");if(t>=r)return u(e,t,r,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=o)return Math.round(e/o)+"d";if(t>=i)return Math.round(e/i)+"h";if(t>=n)return Math.round(e/n)+"m";if(t>=r)return Math.round(e/r)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,r){"use strict";r.r(t);var n=r(0),i=r(1),o=r.n(i);const s=r(4)("xin-router:router"),a=window.URL;class u extends n.Component{get props(){return{...super.props,mode:{type:String,value:"hash"},manual:{type:Boolean,value:!1},hash:{type:String,value:"#!"},rootUri:{type:String,value:"/"},location:{type:Object,value:()=>window.location},history:{type:Object,value:()=>window.history}}}get hashRegexp(){return this.__routerHashRegexp&&this.__routerHash===this.hash||(this.__routerHashRegexp=new RegExp(`${this.hash}(.*)$`),this.__routerHash=this.hash),this.__routerHashRegexp}getClientUri(){try{let e;if("history"===this.mode)e=(e=decodeURI(this.location.pathname+this.location.search)).replace(/\?(.*)$/,""),e="/"===this.rootUri?e:e.replace(this.rootUri,"");else{const t=this.location.href.match(this.hashRegexp);e=t?t[1]:""}return"/"+e.toString().replace(/\/$/,"").replace(/^\//,"")}catch(e){return console.error("Fragment is not match any pattern, fallback to /"),"/"}}get isRoot(){return Boolean(!this.__routerParent)}created(){this.middlewares=[],this.routes=[],this.routers=[]}async attached(){if(this.__routerParent=this.parentElement.closest("xin-router"),!this.isRoot)return this.__routerParent.__routerAddRouter(this),await n.Async.sleep(1),void(this.__middlewareChain=c(this.middlewares));this.setAttribute("root",!0),await n.Async.sleep(1),this.__middlewareChain=c(this.middlewares),this.manual||this.start()}detached(){this.stop(),this.routes.forEach(e=>e.leave()),this.__middlewareChain=void 0,this.isRoot?this.removeAttribute("root"):this.__routerParent.__routerRemoveRouter(this),this.__routerParent=void 0}use(e){this.middlewares.push(e)}async start(){this.isRoot&&(s.enabled&&s(`Starting ${this.is}:${this.__id} ...`),this.__routerListen(),await this.__routerDispatch(this.__routerCreateContext(this.getClientUri())))}stop(){this.isRoot&&(s.enabled&&s(`Stopping ${this.is}:${this.__id} ...`),this.__routerUnlisten())}async push(e,t){if(s("Push %s",e),this.getClientUri()===e)return;const r="history"===this.mode?this.rootUri+e.toString().replace(/\/$/,"").replace(/^\//,""):this.hash+e;this.history.pushState(t,document.title,r),await this.__routerDispatch(this.__routerCreateContext(e,t))}async replace(e,t){if(s("Replace %s",e),this.getClientUri()===e)return;const r="history"===this.mode?this.rootUri+e.toString().replace(/\/$/,"").replace(/^\//,""):this.hash+e;this.history.replaceState(t,document.title,r),await this.__routerDispatch(this.__routerCreateContext(e,t))}go(e){e&&this.history.go(e)}__routerAddRoute(e){this.routes.push(e)}__routerRemoveRoute(e){this.routes=this.routes.filter(t=>t!==e)}__routerAddRouter(e){this.routers.push(e)}__routerRemoveRouter(e){this.routers=this.routers.filter(t=>t!==e)}__routerListen(){this.__routerPopstateListener=async()=>{await this.__routerDispatch(this.__routerCreateContext(this.getClientUri()))},this.__routerClickListener=e=>{if(!e.defaultPrevented&&"A"===e.target.nodeName&&""===e.target.target){e.preventDefault();let t=e.target.getAttribute("href");t.startsWith(this.hash)&&(t=t.split(this.hash).pop()),this.push(t)}},Object(n.event)(window).on("popstate",this.__routerPopstateListener),Object(n.event)(document).on("click",this.__routerClickListener)}__routerUnlisten(){this.__routerPopstateListener&&(Object(n.event)(window).off("popstate",this.__routerPopstateListener),Object(n.event)(document).off("click",this.__routerClickListener))}__routerCreateContext(e,t={}){let{pathname:r,search:n}=new a(e,"http://localhost");return"?"===n[0]&&(n=n.substr(1)),{originalUri:e,uri:e,pathname:r,parameters:{...o.a.parse(n),...t}}}async __routerDispatch(e){await this.__middlewareChain(e,async()=>{await this.__routerRoute(e),await Promise.all(this.routers.map(async t=>{await t.__routerDispatch(e)}))})}async __routerRoute(e){let t;if(await Promise.all(this.routes.map(async r=>{if(r.test(e.pathname))return t=!0,void await r.enter(e);await r.leave(e)})),!t)throw new Error(`Route not found! (uri:${e.getClientUri()})`)}}function c(e){for(const t of e)if("function"!=typeof t)throw new TypeError("Middleware must be composed of functions!");return(t,r)=>{let n=-1;return function i(o){if(o<=n)throw new Error("next() called multiple times");n=o;let s=e[o];if(o===e.length&&(s=r),s)return s(t,()=>i(o+1))}(0)}}Object(n.define)("xin-router",u);class h extends n.Component{static routeRegExp(e){const t=e.split("[");if(t.length>2)throw new Error("Invalid use of optional params");const r=[],n=t[0].replace(/{([^}]+)}/g,function(e,t){return r.push(t),"([^/]+)"}).replace(/\//g,"\\/");let i="";return t[1]&&(i="(?:"+t[1].slice(0,-1).replace(/{([^}]+)}/g,function(e,t){const[n,i="[^/]+"]=t.split(":");return r.push(n),`(${i})`}).replace(/\//g,"\\/")+")?"),[new RegExp("^"+n+i+"$"),r]}static isStatic(e){return!e.match(/[[{]/)}get props(){return{...super.props,uri:{type:String,observer:"__routeObserveUri(uri)",required:!0},view:{type:String}}}attached(){if(super.attached(),this.__routeRouter=this.parentElement.closest("xin-router"),!this.__routeRouter)throw new Error("Missing router instance");this.__routeRouter.__routerAddRoute(this)}detached(){super.detached(),this.__routeRouter.__routerRemoveRoute(this)}__routeObserveUri(e){if(h.isStatic(e))this.type="s",this.pattern=null,this.args=[];else{const[t,r]=h.routeRegExp(e);this.type="v",this.pattern=t,this.args=r}}__routeExtractSegmentParameters(e){const t=e.match(this.pattern);return t?this.args.reduce((e,r,n)=>(e[r]=t[n+1],e),{}):{}}__componentInitTemplate(){this.__routeTemplate=this.firstElementChild,this.__routeTemplate&&this.removeChild(this.__routeTemplate),n.Template.prototype.__templateInitialize.call(this)}test(e){return"s"===this.type&&this.uri===e||"v"===this.type&&e.match(this.pattern)}async enter(e){if(!this.__routeViewElement){const e=document.createElement(this.view||"xin-view");this.view||(e.template=this.__routeTemplate),this.__routeViewElement=e}const t={...this.__routeExtractSegmentParameters(e.pathname),...e.parameters};this.__routeViewElement.set("parameters",t),await this.__routeViewElement.focusing(),Object(n.event)(this.__routeViewElement).fire("focusing",{view:this.__routeViewElement}),await this.parentElement.insertBefore(this.__routeViewElement,this),await this.__routeViewElement.focused(),Object(n.event)(this.__routeViewElement).fire("focus",{view:this.__routeViewElement})}async leave(){this.__routeViewElement&&(await this.parentElement.removeChild(this.__routeViewElement),await this.__routeViewElement.blurred(),Object(n.event)(this.__routeViewElement).fire("blur",{view:this.__routeViewElement}),this.__routeViewElement=void 0)}}Object(n.define)("xin-route",h);class l extends n.Component{get props(){return{...super.props,parameters:{type:Object}}}ready(){super.ready(),this.setAttribute("xin-view","")}focusing(){}focused(){}blurred(){}}Object(n.define)("xin-view",l);class p extends n.Component{attached(){if(super.attached(),void 0===this.parentElement||"function"!=typeof this.parentElement.use)throw new Error("Parent element is not a Router!");this.parentElement.use(this.callback())}callback(){throw new Error("Please define #callback() which return function with signature function(ctx, next)")}}r.d(t,"Router",function(){return u}),r.d(t,"Route",function(){return h}),r.d(t,"View",function(){return l}),r.d(t,"Middleware",function(){return p})}])});